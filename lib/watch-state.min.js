var watchState=function(t){"use strict";var e={};function r(t){return function(){if(e.activeWatchers)return t.apply(this,arguments);var r=e.activeWatcher;e.activeWatcher=void 0;var a=e.activeWatchers=new Set,n=t.apply(this,arguments);return e.activeWatchers=void 0,a.forEach((function(t){return t.update()})),e.activeWatcher=r,n}}function a(t){var r=e.activeWatcher;e.activeWatcher=void 0;var a=t();return e.activeWatcher=r,a}var n=Symbol("state values");function c(t){return n in t||(t[n]={}),t[n]}function i(t){return!!e.activeWatcher&&(e.activeWatcher.onClear(t),!0)}var u=function(){function t(t){this.target=t,this.rendered=!1,this.updating=!1,this.update()}return t.prototype.update=function(){var t=this;this.updating=!0,this.clear(this.cleaners,this.rendered),i((function(){return t.destructor()}));var r=e.activeWatcher;return e.activeWatcher=this,this.target(this.rendered),e.activeWatcher=r,this.rendered=!0,this.updating=!1,this},t.prototype.destructor=function(){return this.clear(this.destructors,!1),this},t.prototype.clear=function(t,e){if(this.cleaners=void 0,this.destructors=void 0,t)for(var r=0;r<t.length;r++)t[r](e);return this},t.prototype.onDestructor=function(t){return this.destructors?this.destructors.push(t):this.destructors=[t],this},t.prototype.onUpdate=function(t){return this.cleaners?this.cleaners.push(t):this.cleaners=[t],this},t.prototype.onClear=function(t){return this.onUpdate(t),this.onDestructor(t),this},t}();var s=function(){function t(t){this.watchers=new Set,this.caches=new Set,this.target=t}return Object.defineProperty(t.prototype,"value",{get:function(){var t=this,r=e.activeWatcher,a=e.activeCache;if(r){var n=this.watchers;if(a){var c=this.caches;c.has(a)||(c.add(a),r.onClear((function(e){e&&c!==t.caches||c.delete(a)})))}else n.has(r)||(n.add(r),r.onClear((function(e){e&&n!==t.watchers||n.delete(r)})))}return this.target},set:function(t){if(t!==this.target){this.target=t;var r=e.activeWatcher;e.activeWatcher=void 0,this.update(),e.activeWatcher=r}},enumerable:!1,configurable:!0}),t.prototype.update=function(){var t=this.updateCache(),a=this.watchers;a.size&&(this.watchers=new Set,e.activeWatchers?a.forEach((function(t){return e.activeWatchers.add(t)})):a.forEach((function(t){return t.update()}))),t&&r((function(){return t.forEach((function(t){return t.checkWatcher()}))}))()},t.prototype.updateCache=function(){var t=this.caches;if(t.size)return this.caches=new Set,h(t)},t}();function h(t,e){return void 0===e&&(e=[]),t.forEach((function(t){var r=t.watcher,a=t.state;r&&(a.watchers.size&&e.push(t),a.caches.size&&h(a.caches,e),t.destructor())})),e}var o=function(){function t(t){this.target=t,this.state=new s}return t.prototype.destructor=function(){var t=this.watcher;this.watcher=void 0,null==t||t.destructor()},t.prototype.checkWatcher=function(){var t=this;this.watcher||a((function(){var r;r=t.watcher=new u((function(a){if(!r||t.watcher===r)if(!a||t.state.watchers.size||t.state.caches.size){var n=e.activeCache;e.activeCache=t,t.state.value=t.target(),e.activeCache=n}else t.destructor()}))}))},Object.defineProperty(t.prototype,"value",{get:function(){return this.checkWatcher(),this.state.value},enumerable:!1,configurable:!0}),t}();var v=function(){function t(t){this.target=t,this.state=new s}return t.prototype.destructor=function(){var t;null===(t=this.watcher)||void 0===t||t.destructor(),this.watcher=void 0},t.prototype.checkWatcher=function(){var t=this;i((function(){t.watcher&&!t.watcher.updating&&t.destructor()})),this.watcher||a((function(){var e;e=t.watcher=new u((function(r){e&&e!==t.watcher||(!r||t.state.watchers.size||t.state.caches.size?t.state.value=t.target():t.destructor())}))}))},Object.defineProperty(t.prototype,"value",{get:function(){return e.activeWatcher?(this.checkWatcher(),this.state.value):this.target()},enumerable:!1,configurable:!0}),t}();return t.Cache=o,t.Mixer=v,t.State=s,t.Watch=u,t.cache=function(t,e,r){var n=r.value,i=r.get,u=void 0===i?n:i;return{get:function(){var t=this,r=c(this);return e in r||a((function(){return r[e]=new o(u.bind(t))})),r[e].value},enumerable:!0}},t.createEvent=r,t.event=function(t,e,a){return{value:r(a.value),enumerable:!0}},t.getCache=function(t,e){return c(t)[e]},t.getDecor=function(t,e){return c(t)[e]},t.getDecors=c,t.getState=function(t,e){return c(t)[e]},t.mixer=function(t,e,r){var n=r.value,i=r.get,u=void 0===i?n:i;return{get:function(){var t=this,r=c(this);return e in r||a((function(){return r[e]=new v(u.bind(t))})),r[e].value},enumerable:!0}},t.onClear=i,t.onDestructor=function(t){return!!e.activeWatcher&&(e.activeWatcher.onDestructor(t),!0)},t.reset=function(){e.activeWatchers=e.activeWatcher=void 0},t.scope=e,t.state=function(t,e,r){var a=r?r.initializer?r.initializer():r.value:void 0;return{get:function(){var t=c(this);return e in t||(t[e]=new s(a)),t[e].value},set:function(t){var r=c(this);e in r?r[e].value=t:r[e]=new s(t)},enumerable:!0}},t.stateValues=function(t){return c(t)},t.unwatch=a,t.watch=function(t,e,r){return{value:function(){return new u(r.value.bind(this))},enumerable:!0}},Object.defineProperty(t,"__esModule",{value:!0}),t}({});
