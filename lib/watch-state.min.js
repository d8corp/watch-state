var watchState=function(t){"use strict";var e={};function r(t){return function(){if(e.activeWatchers)return t.apply(this,arguments);var r=e.activeWatchers=new Set,n=t.apply(this,arguments);return e.activeWatchers=void 0,r.forEach((function(t){return t.update()})),n}}function n(t){var r=e.activeWatcher;e.activeWatcher=void 0;var n=t();return e.activeWatcher=r,n}var i=Symbol("state values");function a(t){return i in t||(t[i]={}),t[i]}function c(t){return!!e.activeWatcher&&(e.activeWatcher.onClear(t),!0)}var u=function(){function t(t){this.target=t,this.rendered=!1,this.update()}return t.prototype.update=function(){var t=this;this.clear(this.cleaners,this.rendered),c((function(){return t.destructor()}));var r=e.activeWatcher;return e.activeWatcher=this,this.target(this.rendered),e.activeWatcher=r,this.rendered=!0,this},t.prototype.destructor=function(){return this.clear(this.destructors,!1),this},t.prototype.clear=function(t,e){if(t)for(var r=0;r<t.length;r++)t[r](e);return this.cleaners=void 0,this.destructors=void 0,this},t.prototype.onDestructor=function(t){return this.destructors?this.destructors.push(t):this.destructors=[t],this},t.prototype.onUpdate=function(t){return this.cleaners?this.cleaners.push(t):this.cleaners=[t],this},t.prototype.onClear=function(t){return this.onUpdate(t),this.onDestructor(t),this},t}();var o=function(){function t(t){this.target=t}return Object.defineProperty(t.prototype,"value",{get:function(){var t=this,r=e.activeWatcher,n=this.watchers;return r&&!n.has(r)&&(n.add(r),c((function(e){e&&n!==t.watchers||n.delete(r)}))),this.target},set:function(t){t!==this.target&&(this.target=t,this.update())},enumerable:!1,configurable:!0}),t.prototype.update=function(){var t=this.watchers;t.size&&(this._watchers=void 0,e.activeWatchers?t.forEach((function(t){return e.activeWatchers.add(t)})):t.forEach((function(t){return t.update()})))},Object.defineProperty(t.prototype,"watchers",{get:function(){return this._watchers||(this._watchers=new Set)},enumerable:!1,configurable:!0}),t}();var s=function(){function t(t){this.target=t,this._value=new o}return t.prototype.destructor=function(){var t;null===(t=this._watcher)||void 0===t||t.destructor()},Object.defineProperty(t.prototype,"value",{get:function(){var t=this;return this._watcher||n((function(){t._watcher=new u((function(e){!e||t._value.watchers.size?t._value.value=t.target():t._watcher=void 0}))})),this._value.value},enumerable:!1,configurable:!0}),t}();return t.Cache=s,t.State=o,t.Watch=u,t.cache=function(t,e,r){var i=r.get;return{get:function(){var t=this,r=a(this);return e in r||n((function(){return r[e]=new s(i.bind(t))})),r[e].value},enumerable:!0}},t.createEvent=r,t.event=function(t,e,n){return{value:r(n.value),enumerable:!0}},t.onClear=c,t.onDestructor=function(t){return!!e.activeWatcher&&(e.activeWatcher.onDestructor(t),!0)},t.reset=function(){e.activeWatchers=e.activeWatcher=void 0},t.scope=e,t.state=function(t,e,r){var n=r?r.initializer?r.initializer():r.value:void 0;return{get:function(){var t=a(this);return e in t||(t[e]=new o(n)),t[e].value},set:function(t){var r=a(this);e in r?r[e].value=t:r[e]=new o(t)},enumerable:!0}},t.stateValues=a,t.unwatch=n,t.watch=function(t,e,r){return{value:function(){return new u(r.value.bind(this))},enumerable:!0}},Object.defineProperty(t,"__esModule",{value:!0}),t}({});
